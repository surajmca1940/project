{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Peer Support Forum" %} - {% trans "Digital Psychological Intervention System" %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 style="color: var(--primary-color);"><i class="bi bi-people"></i> {% trans "Peer Support Forum" %}</h3>
            <button class="btn" data-bs-toggle="modal" data-bs-target="#newPostModal" style="background: linear-gradient(135deg, var(--primary-color), var(--info-color)); color: white; border: none;">
                <i class="bi bi-plus-circle"></i> {% trans "New Post" %}
            </button>
        </div>
        
        <div class="alert" style="background: rgba(212, 185, 150, 0.1); border: 1px solid var(--warning-color); border-radius: 12px; color: var(--dark-color);">
            <i class="bi bi-shield-check" style="color: var(--warning-color);"></i> {% trans "This is a safe, moderated space. Remember to respect privacy and avoid sharing personal identifying information." %}
        </div>
        
        <div class="forum-post">
            <div class="d-flex justify-content-between">
                <div>
                    <span class="author">{% trans "Anonymous Student" %}</span>
                    <span class="timestamp">{% trans "2 hours ago" %}</span>
                </div>
                <span class="badge" style="background: var(--secondary-color); color: white;">{% trans "Discussion" %}</span>
            </div>
            <h5 class="mt-2">{% trans "Dealing with exam anxiety" %}</h5>
            <p>{% trans "Has anyone found effective ways to manage the stress during final exams? I've been having trouble sleeping and concentrating. Any advice would be appreciated." %}</p>
            <div class="d-flex justify-content-between">
                <small class="text-muted">{% trans "5 replies" %}</small>
                <button class="btn btn-sm" style="border: 1px solid var(--primary-color); color: var(--primary-color); background: rgba(124, 147, 195, 0.1);">{% trans "Reply" %}</button>
            </div>
        </div>
        
        <div class="forum-post">
            <div class="d-flex justify-content-between">
                <div>
                    <span class="author">{% trans "Study Buddy" %}</span>
                    <span class="timestamp">{% trans "1 day ago" %}</span>
                </div>
                <span class="badge" style="background: var(--info-color); color: white;">{% trans "Resource Share" %}</span>
            </div>
            <h5 class="mt-2">{% trans "Meditation apps that actually work" %}</h5>
            <p>{% trans "I've been using meditation apps for a few months now and wanted to share the ones that have really helped me with stress and focus. Here are my top 3..." %}</p>
            <div class="d-flex justify-content-between">
                <small class="text-muted">{% trans "12 replies" %}</small>
                <button class="btn btn-sm" style="border: 1px solid var(--primary-color); color: var(--primary-color); background: rgba(124, 147, 195, 0.1);">{% trans "Reply" %}</button>
            </div>
        </div>
        
        <div class="forum-post">
            <div class="d-flex justify-content-between">
                <div>
                    <span class="author">{% trans "HopefulGrad" %}</span>
                    <span class="timestamp">{% trans "3 days ago" %}</span>
                </div>
                <span class="badge" style="background: var(--success-color); color: white;">{% trans "Support" %}</span>
            </div>
            <h5 class="mt-2">{% trans "Thank you to this community" %}</h5>
            <p>{% trans "I just wanted to say thanks to everyone who has been supportive. Going through a tough time but the encouragement here has meant a lot." %}</p>
            <div class="d-flex justify-content-between">
                <small class="text-muted">{% trans "8 replies" %}</small>
                <button class="btn btn-sm" style="border: 1px solid var(--primary-color); color: var(--primary-color); background: rgba(124, 147, 195, 0.1);">{% trans "Reply" %}</button>
            </div>
        </div>
        
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link">{% trans "Previous" %}</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">{% trans "Next" %}</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- New Post Modal -->
<div class="modal fade" id="newPostModal" tabindex="-1" aria-labelledby="newPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newPostModalLabel">{% trans "Create New Post" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="postCategory" class="form-label">{% trans "Category" %}</label>
                        <select class="form-select" id="postCategory">
                            <option value="discussion">{% trans "Discussion" %}</option>
                            <option value="support">{% trans "Support" %}</option>
                            <option value="resource">{% trans "Resource Share" %}</option>
                            <option value="advice">{% trans "Advice Request" %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="postTitle" class="form-label">{% trans "Title" %}</label>
                        <input type="text" class="form-control" id="postTitle" placeholder="{% trans 'Brief description of your post' %}">
                    </div>
                    <div class="mb-3">
                        <label for="postContent" class="form-label">{% trans "Content" %}</label>
                        <textarea class="form-control" id="postContent" rows="5" placeholder="{% trans 'Share your thoughts, questions, or resources...' %}"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="anonymousPost" checked>
                        <label class="form-check-label" for="anonymousPost">
                            {% trans "Post anonymously" %}
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal" style="background: var(--secondary-color); color: white; border: none;">{% trans "Cancel" %}</button>
                <button type="button" class="btn" id="submit-post-btn" style="background: linear-gradient(135deg, var(--primary-color), var(--info-color)); color: white; border: none;">{% trans "Post" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const submitPostBtn = document.getElementById('submit-post-btn');
    const newPostModal = new bootstrap.Modal(document.getElementById('newPostModal'));
    
    if (submitPostBtn) {
        submitPostBtn.addEventListener('click', function() {
            const category = document.getElementById('postCategory').value;
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const isAnonymous = document.getElementById('anonymousPost').checked;
            
            // Validation
            if (!title) {
                alert('{% trans "Please enter a title for your post." %}');
                return;
            }
            
            if (!content) {
                alert('{% trans "Please enter content for your post." %}');
                return;
            }
            
            // Disable button during submission
            submitPostBtn.disabled = true;
            submitPostBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> {% trans "Posting..." %}';
            
            // Create post via API
            fetch('{% url "peer_support:create_post_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: category,
                    title: title,
                    content: content,
                    anonymous: isAnonymous
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Clear form
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                    document.getElementById('postCategory').value = 'discussion';
                    document.getElementById('anonymousPost').checked = true;
                    
                    // Close modal
                    newPostModal.hide();
                    
                    // Show success message
                    alert('{% trans "Your post has been created successfully! (In a real implementation, it would appear in the forum)" %}');
                    
                    // In a real implementation, you would reload the page or add the post to the DOM
                    // location.reload();
                } else {
                    alert(data.error || '{% trans "Failed to create post. Please try again." %}');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{% trans "An error occurred. Please try again." %}');
            })
            .finally(() => {
                // Re-enable button
                submitPostBtn.disabled = false;
                submitPostBtn.innerHTML = '{% trans "Post" %}';
            });
        });
    }
    
    // Make reply buttons functional
    document.querySelectorAll('.btn-outline-primary').forEach(button => {
        if (button.textContent.trim() === '{% trans "Reply" %}') {
            button.addEventListener('click', function() {
                const replyText = prompt('{% trans "Enter your reply:" %}');
                if (replyText && replyText.trim()) {
                    alert('{% trans "Reply posted! (In a real implementation, this would be saved to the database)" %}');
                }
            });
        }
    });
});
</script>
{% endblock %}
