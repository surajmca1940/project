{% extends 'base.html' %}

{% block title %}Peer Support Forum - Digital Psychological Intervention System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-people"></i> Peer Support Forum</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newPostModal">
                <i class="bi bi-plus-circle"></i> New Post
            </button>
        </div>
        
        <div class="alert alert-warning">
            <i class="bi bi-shield-check"></i> This is a safe, moderated space. Remember to respect privacy and avoid sharing personal identifying information.
        </div>
        
        <div class="forum-post">
            <div class="d-flex justify-content-between">
                <div>
                    <span class="author">Anonymous Student</span>
                    <span class="timestamp">2 hours ago</span>
                </div>
                <span class="badge bg-secondary">Discussion</span>
            </div>
            <h5 class="mt-2">Dealing with exam anxiety</h5>
            <p>Has anyone found effective ways to manage the stress during final exams? I've been having trouble sleeping and concentrating. Any advice would be appreciated.</p>
            <div class="d-flex justify-content-between">
                <small class="text-muted">5 replies</small>
                <button class="btn btn-sm btn-outline-primary">Reply</button>
            </div>
        </div>
        
        <div class="forum-post">
            <div class="d-flex justify-content-between">
                <div>
                    <span class="author">Study Buddy</span>
                    <span class="timestamp">1 day ago</span>
                </div>
                <span class="badge bg-info">Resource Share</span>
            </div>
            <h5 class="mt-2">Meditation apps that actually work</h5>
            <p>I've been using meditation apps for a few months now and wanted to share the ones that have really helped me with stress and focus. Here are my top 3...</p>
            <div class="d-flex justify-content-between">
                <small class="text-muted">12 replies</small>
                <button class="btn btn-sm btn-outline-primary">Reply</button>
            </div>
        </div>
        
        <div class="forum-post">
            <div class="d-flex justify-content-between">
                <div>
                    <span class="author">HopefulGrad</span>
                    <span class="timestamp">3 days ago</span>
                </div>
                <span class="badge bg-success">Support</span>
            </div>
            <h5 class="mt-2">Thank you to this community</h5>
            <p>I just wanted to say thanks to everyone who has been supportive. Going through a tough time but the encouragement here has meant a lot.</p>
            <div class="d-flex justify-content-between">
                <small class="text-muted">8 replies</small>
                <button class="btn btn-sm btn-outline-primary">Reply</button>
            </div>
        </div>
        
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link">Previous</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- New Post Modal -->
<div class="modal fade" id="newPostModal" tabindex="-1" aria-labelledby="newPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newPostModalLabel">Create New Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="postCategory" class="form-label">Category</label>
                        <select class="form-select" id="postCategory">
                            <option value="discussion">Discussion</option>
                            <option value="support">Support</option>
                            <option value="resource">Resource Share</option>
                            <option value="advice">Advice Request</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="postTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="postTitle" placeholder="Brief description of your post">
                    </div>
                    <div class="mb-3">
                        <label for="postContent" class="form-label">Content</label>
                        <textarea class="form-control" id="postContent" rows="5" placeholder="Share your thoughts, questions, or resources..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="anonymousPost" checked>
                        <label class="form-check-label" for="anonymousPost">
                            Post anonymously
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submit-post-btn">Post</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const submitPostBtn = document.getElementById('submit-post-btn');
    const newPostModal = new bootstrap.Modal(document.getElementById('newPostModal'));
    
    if (submitPostBtn) {
        submitPostBtn.addEventListener('click', function() {
            const category = document.getElementById('postCategory').value;
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const isAnonymous = document.getElementById('anonymousPost').checked;
            
            // Validation
            if (!title) {
                alert('Please enter a title for your post.');
                return;
            }
            
            if (!content) {
                alert('Please enter content for your post.');
                return;
            }
            
            // Disable button during submission
            submitPostBtn.disabled = true;
            submitPostBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Posting...';
            
            // Create post via API
            fetch('{% url "peer_support:create_post_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: category,
                    title: title,
                    content: content,
                    anonymous: isAnonymous
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Clear form
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                    document.getElementById('postCategory').value = 'discussion';
                    document.getElementById('anonymousPost').checked = true;
                    
                    // Close modal
                    newPostModal.hide();
                    
                    // Show success message
                    alert('Your post has been created successfully! (In a real implementation, it would appear in the forum)');
                    
                    // In a real implementation, you would reload the page or add the post to the DOM
                    // location.reload();
                } else {
                    alert(data.error || 'Failed to create post. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            })
            .finally(() => {
                // Re-enable button
                submitPostBtn.disabled = false;
                submitPostBtn.innerHTML = 'Post';
            });
        });
    }
    
    // Make reply buttons functional
    document.querySelectorAll('.btn-outline-primary').forEach(button => {
        if (button.textContent.trim() === 'Reply') {
            button.addEventListener('click', function() {
                const replyText = prompt('Enter your reply:');
                if (replyText && replyText.trim()) {
                    alert('Reply posted! (In a real implementation, this would be saved to the database)');
                }
            });
        }
    });
});
</script>
{% endblock %}
